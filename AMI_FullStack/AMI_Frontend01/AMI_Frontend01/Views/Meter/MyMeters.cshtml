@{
    ViewData["Title"] = "My Meters";
    Layout = "~/Views/Shared/Dashboard.cshtml";
}

<div class="container py-4">
    <h2 class="fw-bold mb-4">🔌 My Meters</h2>

    <div id="alertBox"></div>

    <div class="table-responsive shadow-sm rounded">
        <table class="table table-striped table-hover table-bordered align-middle">
            <thead class="table-dark text-center">
                <tr>
                    <th>Meter ID</th>
                    <th>Serial No</th>
                    <th>Connection Type</th>
                    <th>Status</th>
                    <th>Installed On</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="meterList">
                <tr>
                    <td colspan="6" class="text-center">Loading meters...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <script>
        const token = localStorage.getItem("jwtToken");
        const email = localStorage.getItem("email");

        if (!token || !email) {
            window.location.href = "/Auth/Login";
        }

        $(document).ready(() => loadConsumerId());

        function loadConsumerId() {
            const encodedEmail = encodeURIComponent(email); // ✅ Encode special characters

            $.ajax({
                url: `https://localhost:7035/api/Consumer/get-id-by-email/${encodedEmail}`,
                type: "GET",
                beforeSend: xhr => xhr.setRequestHeader("Authorization", "Bearer " + token),
                success: consumerId => loadMeters(consumerId),
                error: (xhr) => {
                    if (xhr.status === 404) {
                        showError("Consumer not found. Please check your account.");
                    } else if (xhr.status === 401) {
                        showError("Unauthorized access. Please log in again.");
                        localStorage.removeItem("jwtToken");
                        window.location.href = "/Auth/Login";
                    } else {
                        showError("Could not fetch your profile. Try again later.");
                    }
                }
            });
        }

        function loadMeters(consumerId) {
            $.ajax({
                url: `https://localhost:7035/api/Meter/by-consumer/${consumerId}`,
                type: "GET",
                beforeSend: xhr => xhr.setRequestHeader("Authorization", "Bearer " + token),
                success: meters => renderMeters(meters),
                error: (xhr) => {
                    if (xhr.status === 404) {
                        $("#meterList").html(`<tr><td colspan="6" class="text-center">No meters found for your account.</td></tr>`);
                    } else {
                        showError("Unable to load meters. Try refreshing the page.");
                    }
                }
            });
        }

        function renderMeters(meters) {
            if (!meters || !meters.length) {
                $("#meterList").html(`<tr><td colspan="6" class="text-center">No meters found</td></tr>`);
                return;
            }

            const statusClasses = {
                Active: "bg-success",
                Inactive: "bg-danger",
                Faulty: "bg-warning text-dark",
                Disconnected: "bg-secondary"
            };

            let rows = meters.map(m => {
                const badgeClass = statusClasses[m.status] || "bg-info"; // default color if status unknown
                const statusBadge = `<span class="badge ${badgeClass}">${m.status}</span>`;

                return `
                    <tr class="text-center">
                        <td>${m.meterId}</td>
                        <td>${m.serialNo}</td>
                        <td>${m.category ?? "-"}</td>
                        <td>${statusBadge}</td>
                        <td>${formatDate(m.installDate)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="viewDetails('${m.serialNo}')">View Details</button>
                            <button class="btn btn-sm btn-success" onclick="downloadReport('${m.serialNo}')">Download Report</button>
                        </td>
                    </tr>`;
            }).join("");

            $("#meterList").html(rows);
        }


        function viewDetails(meterId) {
            alert(`Viewing details for Meter: ${meterId}`);
        }

        function downloadReport(meterId) {
            alert(`Downloading report for Meter: ${meterId}`);
        }

        function showError(msg) {
            $("#alertBox").html(`<div class="alert alert-danger">${msg}</div>`);
        }

        function formatDate(d) {
            return d ? new Date(d).toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric' }) : "-";
        }
    </script>
}
