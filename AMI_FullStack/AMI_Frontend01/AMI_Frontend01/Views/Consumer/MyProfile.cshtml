@* @{
    ViewData["Title"] = "My Profile";
    Layout = "~/Views/Shared/Dashboard.cshtml";
}

<div class="container py-4">
    <h2 class="fw-bold mb-4">👤 My Profile</h2>

    <div id="alertBox"></div>

    <div class="card shadow-sm rounded">
        <div class="card-body">

            <div id="profileContent" class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Loading profile...</p>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <script>
        const token = localStorage.getItem("jwtToken");
        const email = localStorage.getItem("email");

        if (!token || !email) {
            window.location.href = "/Auth/Login";
        }

        $(document).ready(() => loadConsumerId());

        function loadConsumerId() {
            $.ajax({
                url: `https://localhost:7035/api/Consumer/get-id-by-email/${email}`,
                type: "GET",
                beforeSend: xhr => xhr.setRequestHeader("Authorization", "Bearer " + token),
                success: consumerId => loadProfile(consumerId),
                error: () => showError("Unable to load your profile. Try logging in again.")
            });
        }

        function loadProfile(consumerId) {
            $.ajax({
                url: `https://localhost:7035/api/Consumer/${consumerId}`,
                type: "GET",
                beforeSend: xhr => xhr.setRequestHeader("Authorization", "Bearer " + token),
                success: profile => renderProfile(profile),
                error: () => showError("Could not load profile details.")
            });
        }

        function renderProfile(p) {
            $("#profileContent").html(`
                <div class="row text-start g-3">

                    <div class="col-md-6">
                        <label class="fw-bold">Consumer ID</label>
                        <div class="form-control bg-light">${p.consumerId}</div>
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold">Full Name</label>
                        <div class="form-control bg-light">${p.name ?? "-"}</div>
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold">Email</label>
                        <div class="form-control bg-light">${p.email ?? "-"}</div>
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold">Phone</label>
                        <div class="form-control bg-light">${p.phone ?? "-"}</div>
                    </div>

                    <div class="col-12">
                        <label class="fw-bold">Address</label>
                        <div class="form-control bg-light">${p.address ?? "-"}</div>
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold">Org Unit ID</label>
                        <div class="form-control bg-light">${p.orgUnitId ?? "-"}</div>
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold">Tariff ID</label>
                        <div class="form-control bg-light">${p.tariffId ?? "-"}</div>
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold">Status</label>
                        <div class="form-control bg-light">${p.status ?? "-"}</div>
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold">Created At</label>
                        <div class="form-control bg-light">${formatDate(p.createdAt)}</div>
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold">Updated At</label>
                        <div class="form-control bg-light">${formatDate(p.updatedAt)}</div>
                    </div>

                </div>
            `);
        }

        function showError(msg) {
            $("#alertBox").html(`<div class="alert alert-danger">${msg}</div>`);
            $("#profileContent").html(`<p class="text-danger">${msg}</p>`);
        }

        function formatDate(d) {
            return d ? new Date(d).toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric' }) : "-";
        }
    </script>
} *@
@{
    ViewData["Title"] = "My Profile";
    Layout = "~/Views/Shared/Dashboard.cshtml";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold mb-0">👤 My Profile</h2>
        <button id="btnSave" class="btn btn-primary" style="display:none;">
            <i class="bi bi-save"></i> Save Changes
        </button>
    </div>

    <div id="alertBox"></div>

    <div class="card shadow-sm rounded">
        <div class="card-body">

            <div id="loadingState" class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Loading profile...</p>
            </div>

            <form id="profileForm" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="fw-bold text-muted small">Consumer ID</label>
                        <input type="text" id="consumerId" class="form-control bg-light" readonly disabled>
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold text-dark small">Full Name <i class="bi bi-pencil-fill text-primary small ms-1"></i></label>
                        <input type="text" id="name" class="form-control border-primary">
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold text-dark small">Email <i class="bi bi-pencil-fill text-primary small ms-1"></i></label>
                        <input type="email" id="email" class="form-control border-primary">
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold text-dark small">Phone <i class="bi bi-pencil-fill text-primary small ms-1"></i></label>
                        <input type="text" id="phone" class="form-control border-primary">
                    </div>

                    <div class="col-12">
                        <label class="fw-bold text-muted small">Address</label>
                        <input type="text" id="address" class="form-control bg-light" readonly disabled>
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold text-muted small">Org Unit ID</label>
                        <input type="text" id="orgUnitId" class="form-control bg-light" readonly disabled>
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold text-muted small">Tariff ID</label>
                        <input type="text" id="tariffId" class="form-control bg-light" readonly disabled>
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold text-muted small">Status</label>
                        <input type="text" id="status" class="form-control bg-light" readonly disabled>
                    </div>

                    <div class="col-md-3">
                        <label class="fw-bold text-muted small">Created At</label>
                        <input type="text" id="createdAt" class="form-control bg-light" readonly disabled>
                    </div>
                    <div class="col-md-3">
                        <label class="fw-bold text-muted small">Updated At</label>
                        <input type="text" id="updatedAt" class="form-control bg-light" readonly disabled>
                    </div>
                </div>
            </form>

        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <script>
        const token = localStorage.getItem("jwtToken");
        let storedEmail = localStorage.getItem("email");
        // Important: Use relative path or your specific port
        const apiBase = "https://localhost:7035/api/Consumer";

        // We store the full object here so we don't lose data when sending updates
        let currentProfileData = null;

        if (!token || !storedEmail) {
            window.location.href = "/Auth/Login";
        }

        $(document).ready(() => loadConsumerId());

        // 1. Get ID from Email
        function loadConsumerId() {
            $.ajax({
                url: `${apiBase}/get-id-by-email/${storedEmail}`,
                type: "GET",
                beforeSend: xhr => xhr.setRequestHeader("Authorization", "Bearer " + token),
                success: consumerId => loadProfile(consumerId),
                error: () => showError("Unable to load your profile. Try logging in again.")
            });
        }

        // 2. Get Profile Details
        function loadProfile(consumerId) {
            $.ajax({
                url: `${apiBase}/${consumerId}`,
                type: "GET",
                beforeSend: xhr => xhr.setRequestHeader("Authorization", "Bearer " + token),
                success: profile => {
                    currentProfileData = profile; // Store global copy
                    renderProfile(profile);
                },
                error: () => showError("Could not load profile details.")
            });
        }

        // 3. Fill the Form
        function renderProfile(p) {
            $("#loadingState").hide();
            $("#profileForm").fadeIn();
            $("#btnSave").fadeIn();

            // Fill Editable Fields
            $("#name").val(p.name);
            $("#email").val(p.email);
            $("#phone").val(p.phone);

            // Fill Read-Only Fields
            $("#consumerId").val(p.consumerId);
            $("#address").val(p.address);
            $("#orgUnitId").val(p.orgUnitId);
            $("#tariffId").val(p.tariffId);
            $("#status").val(p.status);
            $("#createdAt").val(formatDate(p.createdAt));
            $("#updatedAt").val(formatDate(p.updatedAt));
        }

        // 4. Update Profile Logic
        $("#btnSave").click(function() {
            if(!currentProfileData) return;

            const btn = $(this);
            const originalText = btn.html();
            btn.prop("disabled", true).html('<span class="spinner-border spinner-border-sm"></span> Saving...');

            // Update our local object with the specific edited fields
            // We keep the other fields (ID, Address, etc) intact from the original object
            const updatedProfile = {
                ...currentProfileData, // Copy existing data
                name: $("#name").val(),
                email: $("#email").val(),
                phone: $("#phone").val()
            };

            $.ajax({
                url: `${apiBase}/${updatedProfile.consumerId}`,
                type: "PUT", // Assuming your API uses PUT for updates
                contentType: "application/json",
                data: JSON.stringify(updatedProfile),
                beforeSend: xhr => xhr.setRequestHeader("Authorization", "Bearer " + token),
                success: function() {
                    btn.prop("disabled", false).html(originalText);

                    // Update LocalStorage if email changed
                    if(updatedProfile.email !== storedEmail) {
                        localStorage.setItem("email", updatedProfile.email);
                        storedEmail = updatedProfile.email;
                    }

                    $("#alertBox").html(`<div class="alert alert-success alert-dismissible fade show">Profile updated successfully! <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`);

                    // Reload to ensure data consistency (updatedAt dates, etc)
                    loadProfile(updatedProfile.consumerId);
                },
                error: function(xhr) {
                    btn.prop("disabled", false).html(originalText);
                    let msg = xhr.responseJSON?.message || "Failed to update profile.";
                    $("#alertBox").html(`<div class="alert alert-danger">${msg}</div>`);
                }
            });
        });

        function showError(msg) {
            $("#loadingState").hide();
            $("#alertBox").html(`<div class="alert alert-danger">${msg}</div>`);
        }

        function formatDate(d) {
            return d ? new Date(d).toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric' }) : "-";
        }
    </script>
}