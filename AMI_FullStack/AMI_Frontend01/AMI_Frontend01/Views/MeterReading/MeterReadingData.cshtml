@{
    Layout = "~/Views/Shared/DashBoard.cshtml";
    ViewData["Title"] = "Meter Reading Management";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

<style>
    body {
        background: #FAF8F2 !important;
        font-family: 'Segoe UI', sans-serif;
        color: #3B3B3B;
    }

    .page-title {
        font-size: 28px;
        font-weight: 600;
        color: #2D6A4F !important;
    }

    .form-control {
        background: #FFFFFF;
        border: 1px solid #B7E4C7;
        color: #3B3B3B;
        border-radius: 8px;
    }

        .form-control:focus {
            box-shadow: 0 0 6px #52B788;
            border-color: #2D6A4F;
        }

    .btn-primary {
        background: #2D6A4F !important;
        border-color: #2D6A4F !important;
        color: #fff !important;
    }

    .btn-success {
        background: #52B788 !important;
        border-color: #52B788 !important;
        color: #fff !important;
    }

    .btn-warning {
        background: #FFD166 !important;
        border-color: #FFD166 !important;
        color: #1B4332 !important;
    }

    .btn-danger {
        background: #d9534f !important;
        border-color: #d9534f !important;
        color: #fff !important;
    }

    .btn:hover {
        opacity: 0.9;
    }

    .card {
        background: #FFFFFF;
        border-radius: 12px;
        border: 1px solid #B7E4C7;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    }

    table thead {
        background: #2D6A4F !important;
        color: white !important;
    }

    table.table-hover tbody tr:hover {
        background: #D8F3DC !important;
        color: #1B4332 !important;
    }

    table.table-bordered {
        border: 1px solid #B7E4C7;
    }

    .modal-content {
        background: #FFFFFF !important;
        border: 1px solid #B7E4C7;
        border-radius: 14px;
    }

    .modal-header {
        background: #2D6A4F !important;
        color: #FFFFFF !important;
    }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="page-title">📊 Meter Reading Management</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">
            <i class="bi bi-plus-circle"></i> Add Reading
        </button>
    </div>

    <div class="card p-3 mb-3">
        <input id="searchBox" class="form-control" placeholder="Search by Meter Serial or Consumer ID..." onkeyup="filterReadings()" />
    </div>

    <div class="card p-3">
        <table class="table table-hover table-bordered">
            <thead>
                <tr>
                    <th>Reading ID</th>
                    <th>Meter Serial No</th>
                    <th>Consumer ID</th>
                    <th>Reading Date</th>
                    <th>KWH</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="readingTableBody" class="text-center"></tbody>
        </table>

        <!-- Pagination Controls -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <button class="btn btn-primary btn-sm" onclick="prevPage()">Previous</button>
            <span id="pageInfo" class="fw-bold text-success"></span>
            <button class="btn btn-primary btn-sm" onclick="nextPage()">Next</button>
        </div>
    </div>
</div>

<!-- Add Modal -->
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Meter Reading</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addReadingForm">
                    <div class="mb-3">
                        <label class="form-label">Meter Serial No</label>
                        <input type="text" id="MeterSerialNo" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reading Date</label>
                        <input type="date" id="ReadingDate" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">KWH</label>
                        <input type="number" id="Kwh" class="form-control" required step="0.01" min="0">
                    </div>
                    <button type="submit" class="btn btn-success w-100">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Edit Meter Reading</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editReadingForm">
                    <input type="hidden" id="EditReadingId">
                    <div class="mb-3">
                        <label class="form-label">Meter Serial No</label>
                        <input type="text" id="EditMeterSerialNo" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reading Date</label>
                        <input type="date" id="EditReadingDate" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">KWH</label>
                        <input type="number" id="EditKwh" class="form-control" required step="0.01" min="0">
                    </div>
                    <button type="submit" class="btn btn-warning w-100">Update</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

    const API_BASE = "https://localhost:7035/api/MeterReading";
    let readings = [];

    // Pagination
    let currentPage = 1;
    const rowsPerPage = 10;

    $(document).ready(() => loadReadings());

    /* ================================
       LOAD ALL READINGS
    ================================= */
    function loadReadings() {
        $.ajax({
            url: API_BASE,
            type: "GET",
            success: data => {
                readings = data;
                currentPage = 1;
                renderTable(readings);
            },
            error: () => alert("❌ Failed to load meter readings.")
        });
    }

    /* ================================
       RENDER TABLE + PAGINATION
    ================================= */
    function renderTable(data) {
        const totalPages = Math.ceil(data.length / rowsPerPage) || 1;

        if (currentPage > totalPages) currentPage = totalPages;

        const start = (currentPage - 1) * rowsPerPage;
        const rows = data.slice(start, start + rowsPerPage);

        let html = "";

        rows.forEach(r => {
            html += `
                <tr>
                    <td>${r.readingId}</td>
                    <td>${r.meterSerialNo}</td>
                    <td>${r.consumerId}</td>
                    <td>${formatDate(r.readingDate)}</td>
                    <td>${r.kwh}</td>
                    <td>${formatDateTime(r.createdAt)}</td>
                    <td>
                        <span class="badge bg-secondary">Read-only</span>
                    </td>
                </tr>
            `;
        });

        $("#readingTableBody").html(html);
        $("#pageInfo").text(`Page ${currentPage} of ${totalPages}`);
    }

    /* Pagination buttons */
    function nextPage() {
        const totalPages = Math.ceil(readings.length / rowsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            filterReadings();
        }
    }
    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            filterReadings();
        }
    }

    /* ================================
       ADD READING (POST)
    ================================= */
    $("#addReadingForm").submit(function (e) {
        e.preventDefault();

        const dto = {
            meterSerialNo: $("#MeterSerialNo").val().trim(),
            readingDate: $("#ReadingDate").val(),
            kwh: Number($("#Kwh").val())
        };

        // Validations
        if (!dto.meterSerialNo) return alert("❌ Meter Serial No is required.");
        if (!dto.readingDate) return alert("❌ Reading date is required.");
        if (dto.kwh < 0) return alert("❌ KWH must be positive.");

        $.ajax({
            url: API_BASE,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(dto),
            success: () => {
                $("#addModal").modal("hide");
                $("#addReadingForm")[0].reset();
                loadReadings();
                alert("✅ Reading added successfully!");
            },
            error: (xhr) => {
                alert("❌ Error: " + xhr.responseText);
            }
        });
    });

    /* ================================
       SEARCH
    ================================= */
    function filterReadings() {
        const q = $("#searchBox").val().toLowerCase();

        const filtered = readings.filter(r =>
            r.meterSerialNo.toLowerCase().includes(q) ||
            r.consumerId.toString().includes(q)
        );

        renderTable(filtered);
    }

    /* Helpers */
    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString();
    }
    function formatDateTime(dateString) {
        return new Date(dateString).toLocaleString();
    }

</script>
