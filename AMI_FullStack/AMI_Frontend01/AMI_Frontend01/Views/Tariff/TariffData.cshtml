@{
    Layout = "~/Views/Shared/Dashboard.cshtml";
    ViewData["Title"] = "Tariff Management";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

<style>
    body {
        background-color: #FAF8F2 !important;
        font-family: 'Segoe UI', sans-serif;
    }

    h2.text-primary {
        color: #14532d !important;
    }

    .table thead {
        background-color: #14532d !important;
        color: white !important;
    }

    .table-hover tbody tr:hover {
        background-color: #D8F3DC !important;
    }

    .btn-success {
        background-color: #14532d !important;
        border-color: #14532d !important;
    }

        .btn-success:hover {
            background-color: #0f3d2e !important;
            border-color: #0f3d2e !important;
        }

    .btn-outline-danger {
        color: #dc3545 !important;
        border-color: #dc3545 !important;
    }

        .btn-outline-danger:hover {
            background-color: #dc3545 !important;
            color: white !important;
        }

    .table-responsive {
        background: #fff;
        border-radius: 12px;
        border: 1px solid #B7E4C7;
        box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
</style>

<div class="container py-4">
    <h2 class="text-center fw-bold text-primary mb-4">Tariff Management</h2>

    <div id="alertBox"></div>

    <!-- Add Button - Only Admin -->
    <div class="text-end mb-3" id="addBtnBox" style="display:none;">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTariffModal">
            <i class="bi bi-plus-circle"></i> Add Tariff
        </button>
    </div>

    <!-- Table -->
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Effective From</th>
                    <th>Effective To</th>
                    <th>Base Rate</th>
                    <th>Tax Rate</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tariffTable"></tbody>
        </table>
    </div>
</div>

<!-- ADD MODAL ONLY -->
<div class="modal fade" id="addTariffModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="addTariffForm">
                <div class="modal-header">
                    <h5 class="modal-title text-white">Add Tariff</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tariff Name</label>
                            <input type="text" id="Name" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Effective To</label>
                            <input type="date" id="EffectiveTo" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Base Rate</label>
                            <input type="number" id="BaseRate" class="form-control" min="0.01" step="0.01" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tax Rate (%)</label>
                            <input type="number" id="TaxRate" class="form-control" min="0" max="100" required />
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-success" type="submit">Save</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const apiBase = "https://localhost:7035/api/Tariff";
        let userRole = localStorage.getItem("role") || "User";

        // Show add button for admin only
        if (userRole === "Admin") {
            document.getElementById("addBtnBox").style.display = "block";
        }

        // Load tariffs
        function loadTariffs() {
            $.get(apiBase, function (data) {
                let rows = "";
                data.forEach(t => {
                    rows += `
                    <tr>
                        <td>${t.tariffId}</td>
                        <td>${t.name}</td>
                        <td>${new Date(t.effectiveFrom).toLocaleDateString()}</td>
                        <td>${t.effectiveTo ? new Date(t.effectiveTo).toLocaleDateString() : "-"}</td>
                        <td>${t.baseRate.toFixed(2)}</td>
                        <td>${t.taxRate.toFixed(2)}</td>
                        <td>
                            ${userRole === "Admin" ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTariff(${t.tariffId})">
                                    <i class="bi bi-trash"></i> Delete
                                </button>` :
                                "No Actions"
                            }
                        </td>
                    </tr>`;
                });
                $("#tariffTable").html(rows);
            });
        }

        // Add tariff (Admin only)
        $("#addTariffForm").submit(function (e) {
            e.preventDefault();

            if (userRole !== "Admin") {
                alert("Only admin can add tariffs.");
                return;
            }

            const dto = {
                name: $("#Name").val(),
                effectiveTo: $("#EffectiveTo").val() || null,
                baseRate: parseFloat($("#BaseRate").val()),
                taxRate: parseFloat($("#TaxRate").val())
            };

            $.ajax({
                url: apiBase,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(dto),
                success: () => {
                    alert("Tariff added successfully.");
                    $("#addTariffModal").modal("hide");
                    $("#addTariffForm")[0].reset();
                    loadTariffs();
                },
                error: function(xhr) {
                    let msg = "Failed to add tariff.";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        msg = xhr.responseJSON.message;
                    }
                    alert(msg);
                }
            });
        });

        // Delete tariff (Admin only)
        function deleteTariff(id) {
            if (userRole !== "Admin") {
                alert("Only admin can delete tariffs.");
                return;
            }

            if (!confirm("Are you sure you want to delete this tariff?")) return;

            $.ajax({
                url: `${apiBase}/${id}`,
                method: "DELETE",
                success: function() {
                    alert("Tariff deleted successfully.");
                    loadTariffs();
                },
                error: function(xhr) {
                    // Show backend FK error or other messages
                    let msg = "Failed to delete tariff.";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        msg = xhr.responseJSON.message;
                    }
                    alert(msg);
                }
            });
        }

        $(document).ready(loadTariffs);
    </script>
}
