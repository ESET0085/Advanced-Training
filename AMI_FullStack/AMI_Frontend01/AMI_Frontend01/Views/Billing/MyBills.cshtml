@{
    ViewData["Title"] = "My Bills";
    Layout = "~/Views/Shared/Dashboard.cshtml";
}

<div class="container py-4">
    <h2 class="fw-bold mb-4">🧾 My Bills</h2>

    <div id="alertBox"></div>

    <table class="table table-striped table-hover table-bordered align-middle">
        <thead class="table-dark">
            <tr>
                <th>Bill ID</th>
                <th>Meter Serial No</th>
                <th>Month</th>
                <th>Units</th>
                <th>Amount</th>
                <th>Tax</th>
                <th>Total</th>
                <th>Status</th>
                <th>Generated On</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="billList">
            <tr><td colspan="10" class="text-center">Loading bills...</td></tr>
        </tbody>
    </table>
</div>

<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="paymentModalLabel">Pay Bill</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    You are about to pay for Bill ID: <strong><span id="modalBillId"></span></strong>
                </div>

                <div class="d-flex justify-content-between mb-3">
                    <span class="fw-bold">Total Amount:</span>
                    <span class="fs-5 text-success fw-bold">₹<span id="modalTotalAmount"></span></span>
                </div>

                <div class="mb-3">
                    <label for="paymentMethod" class="form-label">Select Payment Method:</label>
                    <select id="paymentMethod" class="form-select">
                        <option value="Credit Card">Credit/Debit Card</option>
                        <option value="UPI">UPI</option>
                        <option value="Net Banking">Net Banking</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmPaymentBtn" class="btn btn-success">
                    <i class="bi bi-credit-card"></i> Pay Now
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const token = localStorage.getItem("jwtToken");
        const email = localStorage.getItem("email");
        const apiBaseUrl = "https://localhost:7035/api"; // Centralized API URL
        let selectedBill = null;

        // 1. Auth Check
        if (!token || !email) {
            window.location.href = "/Auth/Login";
        }

        $(document).ready(() => loadConsumerId());

        // 2. Get Consumer ID
        function loadConsumerId() {
            $.ajax({
                url: `${apiBaseUrl}/Consumer/get-id-by-email/${email}`,
                type: "GET",
                headers: { "Authorization": "Bearer " + token },
                success: consumerId => loadBills(consumerId),
                error: () => showError("Unable to load your Consumer ID. Please log in again.")
            });
        }

        // 3. Load Bills
        function loadBills(consumerId) {
            $.ajax({
                url: `${apiBaseUrl}/Billing/ByConsumer/${consumerId}`,
                type: "GET",
                headers: { "Authorization": "Bearer " + token },
                success: bills => renderBills(bills),
                error: xhr => {
                    if (xhr.status === 404)
                        $("#billList").html(`<tr><td colspan="10" class="text-center">No bills found for your account.</td></tr>`);
                    else
                        showError("Unable to load bills.");
                }
            });
        }

        // 4. Render Table
        function renderBills(bills) {
            if (!bills || bills.length === 0) {
                $("#billList").html(`<tr><td colspan="10" class="text-center">No bills found</td></tr>`);
                return;
            }

            let rows = bills.map(b => {
                const billingStart = new Date(b.billingPeriodStart);
                const month = billingStart.toLocaleString('default', { month: 'short', year: 'numeric' });

                const isPending = b.status === 'Pending';

                // UI States
                const badgeClass = isPending ? 'bg-warning text-dark' : 'bg-success';
                const actionBtn = isPending
                    ? `<button class="btn btn-sm btn-primary payBtn" data-bill='${JSON.stringify(b)}'>Pay Now</button>`
                    : `<span class="text-muted fw-bold"><i class="bi bi-check-circle-fill text-success"></i> Paid</span>`;

                // Added ID to TR for easy updating later
                return `
                    <tr id="row-${b.billId}">
                        <td>${b.billId}</td>
                        <td>${b.meterSerialNo}</td>
                        <td>${month}</td>
                        <td>${b.unitsConsumed.toFixed(2)}</td>
                        <td>₹${b.amount.toFixed(2)}</td>
                        <td>₹${b.taxAmount.toFixed(2)}</td>
                        <td>₹${b.totalAmount.toFixed(2)}</td>
                        <td class="status-cell"><span class="badge ${badgeClass}">${b.status}</span></td>
                        <td>${formatDate(b.generatedDate)}</td>
                        <td class="action-cell">${actionBtn}</td>
                    </tr>
                `;
            }).join("");

            $("#billList").html(rows);

            // Re-bind click events
            bindPayButtons();
        }

        function bindPayButtons() {
            $(".payBtn").off('click').click(function() {
                selectedBill = JSON.parse($(this).attr('data-bill'));

                // Populate Modal
                $("#modalBillId").text(selectedBill.billId);
                $("#modalTotalAmount").text(selectedBill.totalAmount.toFixed(2));

                const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
                modal.show();
            });
        }

        // 5. Handle Payment Logic
        $("#confirmPaymentBtn").click(function() {
            if (!selectedBill) return;

            const btn = $(this);
            const originalText = btn.html();
            const paymentMethod = $("#paymentMethod").val();

            // UI Loading State
            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Processing...');

            $.ajax({
                url: `${apiBaseUrl}/Billing/pay/${selectedBill.billId}`,
                type: "POST", // Ensure your API accepts POST for this
                contentType: "application/json",
                data: JSON.stringify({ method: paymentMethod }),
                headers: { "Authorization": "Bearer " + token },
                success: () => {
                    // A. Close Modal
                    const modalEl = document.getElementById('paymentModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();

                    // B. Show Success Alert
                    $("#alertBox").html(`
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle"></i> Payment successful for Bill #${selectedBill.billId}!
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `);

                    // C. UPDATE UI INSTANTLY (Without reloading page)
                    const row = $(`#row-${selectedBill.billId}`);

                    // Update Status Column
                    row.find('.status-cell').html('<span class="badge bg-success">Paid</span>');

                    // Update Action Column
                    row.find('.action-cell').html('<span class="text-muted fw-bold"><i class="bi bi-check-circle-fill text-success"></i> Paid</span>');

                    // D. Cleanup
                    btn.prop('disabled', false).html(originalText);
                    selectedBill = null;
                },
                error: (xhr) => {
                    btn.prop('disabled', false).html(originalText);
                    alert("Payment failed: " + (xhr.responseText || "Please try again."));
                }
            });
        });

        // Helpers
        function showError(msg) {
            $("#alertBox").html(`<div class="alert alert-danger">${msg}</div>`);
        }

        function formatDate(dateStr) {
            if (!dateStr) return "-";
            return new Date(dateStr).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        }
    </script>
}