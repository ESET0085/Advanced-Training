@{
    Layout = "~/Views/Shared/Dashboard.cshtml";
    ViewData["Title"] = "Tariff Slab Management";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

<div class="container py-4">
    <h2 class="text-center fw-bold text-primary mb-4">Tariff Slab Management</h2>

    <div id="alertBox"></div>

    <!-- Filters & Add Button -->
    <div class="row mb-3 align-items-center">
        <div class="col-md-4 mb-2">
            <select id="TariffSelector" class="form-select shadow-sm border-primary" onchange="loadSlabs(this.value)">
                <option value="1">Tariff 1</option>
                <option value="2">Tariff 2</option>
            </select>
        </div>
        <div class="col-md-4 mb-2">
            <input type="number" id="searchSlabId" class="form-control shadow-sm border-primary" placeholder="Search by Slab ID..." />
        </div>
        <div class="col-md-2 mb-2 d-flex gap-1">
            <button class="btn btn-primary w-100" onclick="filterSlabs()">
                <i class="bi bi-funnel-fill"></i> Filter
            </button>
            <button class="btn btn-secondary w-100" onclick="resetFilter()">
                <i class="bi bi-arrow-counterclockwise"></i> Reset
            </button>
        </div>
        <div class="col-md-2 text-end mb-2" id="addSlabBtnBox" style="display:none;">
            <button class="btn btn-success shadow-sm" type="button" onclick="openSlabModal()">
                <i class="bi bi-plus-circle"></i> Add Slab
            </button>
        </div>
    </div>

    <!-- Table -->
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-primary text-dark">
                <tr>
                    <th>ID</th>
                    <th>Tariff ID</th>
                    <th>From kWh</th>
                    <th>To kWh</th>
                    <th>Rate per kWh</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="slabTable"></tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="slabModal" tabindex="-1" aria-labelledby="slabModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content shadow">
            <form id="slabForm">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="slabModalLabel">Add Slab</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <input type="hidden" id="TariffSlabId" />
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Tariff ID</label>
                            <input type="number" id="TariffId" class="form-control border-primary shadow-sm" required min="1" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">From kWh</label>
                            <input type="number" id="FromKwh" class="form-control border-primary shadow-sm" required min="0" step="0.01" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">To kWh</label>
                            <input type="number" id="ToKwh" class="form-control border-primary shadow-sm" required min="0.01" step="0.01" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Rate per kWh</label>
                            <input type="number" id="RatePerKwh" class="form-control border-primary shadow-sm" required min="0.01" step="0.01" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success shadow-sm">Save</button>
                    <button type="button" class="btn btn-secondary shadow-sm" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const apiBase = "https://localhost:7035/api/TariffSlab";
        let allSlabs = [];
        let selectedTariffId = 1;
        const userRole = localStorage.getItem("role") || "User";

        // Show Add button only for Admin
        if (userRole === "Admin") document.getElementById("addSlabBtnBox").style.display = "block";

        function loadSlabs(tariffId = 1) {
            selectedTariffId = tariffId;
            $.get(`${apiBase}/${tariffId}`, function (data) {
                allSlabs = data;
                renderTable(allSlabs);
            }).fail(() => showAlert("Cannot load slabs", "danger"));
        }

        function renderTable(data) {
            let rows = "";
            data.forEach(s => {
                const actions = userRole === "Admin" ? `
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editSlab(${s.tariffSlabId})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSlab(${s.tariffSlabId})">
                        <i class="bi bi-trash"></i>
                    </button>` : "No Actions";

                rows += `<tr>
                    <td>${s.tariffSlabId}</td>
                    <td>${s.tariffId}</td>
                    <td>${s.fromKwh.toFixed(2)}</td>
                    <td>${s.toKwh.toFixed(2)}</td>
                    <td>${s.ratePerKwh.toFixed(2)}</td>
                    <td class="text-center">${actions}</td>
                </tr>`;
            });
            $("#slabTable").html(rows);
        }

        function showAlert(msg, type = "success") {
            $("#alertBox").html(`<div class="alert alert-${type} alert-dismissible fade show shadow-sm">
                ${msg}
                <button class="btn-close" data-bs-dismiss="alert"></button>
            </div>`);
        }

        function openSlabModal(slab = null) {
            if (slab) {
                $("#TariffSlabId").val(slab.tariffSlabId);
                $("#TariffId").val(slab.tariffId);
                $("#FromKwh").val(slab.fromKwh);
                $("#ToKwh").val(slab.toKwh);
                $("#RatePerKwh").val(slab.ratePerKwh);
                $("#slabModalLabel").text("Edit Slab");
            } else {
                $("#slabForm")[0].reset();
                $("#TariffSlabId").val("");
                $("#TariffId").val(selectedTariffId); // auto-fill based on selected tariff
                $("#slabModalLabel").text("Add Slab");
            }
            new bootstrap.Modal(document.getElementById('slabModal')).show();
        }

        $("#slabForm").submit(function (e) {
            e.preventDefault();
            if (userRole !== "Admin") return showAlert("Only Admin can add/edit slabs.", "danger");

            const id = $("#TariffSlabId").val();

            // Build DTO
            const dto = {
                tariffId: parseInt($("#TariffId").val()),
                fromKwh: parseFloat($("#FromKwh").val()),
                toKwh: parseFloat($("#ToKwh").val()),
                ratePerKwh: parseFloat($("#RatePerKwh").val())
            };

            // Include TariffSlabId only for edit
            if (id) dto.tariffSlabId = parseInt(id);

            if (dto.fromKwh >= dto.toKwh) return showAlert("From kWh must be less than To kWh.", "danger");

            const method = id ? "PUT" : "POST";
            const url = id ? `${apiBase}/${id}` : apiBase;

            $.ajax({
                url,
                method,
                contentType: "application/json",
                data: JSON.stringify(dto),
                success: () => {
                    showAlert(id ? "Slab updated successfully!" : "Slab added successfully!");
                    const modalEl = document.getElementById('slabModal');
                    bootstrap.Modal.getInstance(modalEl).hide();
                    $("#slabForm")[0].reset();
                    $("#TariffSlabId").val("");
                    $("#slabModalLabel").text("Add Slab");
                    loadSlabs(selectedTariffId);
                },
                error: (xhr) => {
                    let msg = "Failed to save slab.";
                    if (xhr.responseJSON && xhr.responseJSON.errors) {
                        msg = Object.values(xhr.responseJSON.errors).flat().join("<br/>");
                    }
                    showAlert(msg, "danger");
                }
            });
        });

        function editSlab(id) {
            if (userRole !== "Admin") return;
            const slab = allSlabs.find(s => s.tariffSlabId === id);
            if (!slab) return showAlert("Slab not found", "danger");
            openSlabModal(slab);
        }

        function deleteSlab(id) {
            if (userRole !== "Admin") return;
            if (!confirm("Are you sure you want to delete this slab?")) return;

            $.ajax({
                url: `${apiBase}/${id}`,
                method: "DELETE",
                success: () => {
                    showAlert("Slab deleted successfully!");
                    loadSlabs(selectedTariffId);
                },
                error: () => showAlert("Failed to delete slab.", "danger")
            });
        }

        function filterSlabs() {
            const filterId = parseInt($("#searchSlabId").val());
            if (!filterId) return renderTable(allSlabs);
            const filtered = allSlabs.filter(s => s.tariffSlabId === filterId);
            renderTable(filtered);
        }

        function resetFilter() {
            $("#searchSlabId").val("");
            renderTable(allSlabs);
        }

        $(document).ready(function () {
            loadSlabs(selectedTariffId);
        });
    </script>
}
